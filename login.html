<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login ‚Äî Centro Educacional Popular Saber Viver</title>
<style>
:root {
  --bg:#F4FBF7;
  --card:#FFFFFF;
  --accent:#1e40af;
  --muted:#374151;
  --radius:14px;
  font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;}
body{background:var(--bg);display:flex;align-items:center;justify-content:center;padding:32px;color:var(--muted);}
.container{width:100%;max-width:900px;display:grid;grid-template-columns:1fr 420px;gap:28px;align-items:center;}
.brand{display:flex;align-items:center;gap:14px;margin-bottom:18px;}
.logo{width:72px;height:72px;border-radius:12px;background:transparent;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;}
.logo-img{width:100%;height:100%;object-fit:contain;display:block;background:transparent;}
h1{margin:0;font-size:28px;}
p.lead{margin-top:10px;color:var(--muted);}
.card{background:var(--card);border-radius:18px;box-shadow:0 8px 30px rgba(11,143,110,0.08);padding:28px;display:flex;flex-direction:column;gap:14px;}
form{display:flex;flex-direction:column;gap:14px;}
label{font-size:13px;color:var(--muted);}
input[type="text"], input[type="password"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #E6F0EC;background:#FBFFFE;font-size:15px;}
.btn{background:var(--accent);color:white;border:none;padding:12px 14px;border-radius:12px;font-weight:600;cursor:pointer;font-size:15px;}
.btn:hover{opacity:0.9;}
.meta{display:flex;justify-content:center;align-items:center;font-size:14px;color:var(--muted);}
.illustration{height:100%;border-radius:18px;padding:28px;display:flex;flex-direction:column;justify-content:center;gap:18px;background:linear-gradient(180deg, rgba(30,64,175,0.05), rgba(37,99,235,0.03));}
.illustration h2{margin:0;}
.footnote{font-size:13px;color:var(--muted);}
.toggle-pass{background:transparent;border:none;cursor:pointer;font-size:13px;color:var(--accent);padding:6px;}
.auth-message{padding:12px;border-radius:8px;margin-bottom:16px;font-size:14px;}
.status-indicator{position:fixed;top:16px;right:16px;padding:8px 12px;border-radius:20px;font-size:12px;font-weight:600;z-index:1000;}
.status-api{background:#d1fae5;color:#065f46;border:1px solid #a7f3d0;}
.status-local{background:#fef3c7;color:#92400e;border:1px solid #fde68a;}
.status-error{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;}
@media (max-width:900px){.container{grid-template-columns:1fr;}.logo{width:56px;height:56px;}.status-indicator{position:relative;top:auto;right:auto;margin-bottom:16px;}}
</style>
</head>
<body>
<div id="statusIndicator" class="status-indicator status-api" style="display:none;">
  üåê Verificando API...
</div>

<main class="container">
  <section class="illustration">
    <div class="brand">
      <div class="logo">
        <img src="fotos/logo.png" alt="Logotipo Saber Viver" class="logo-img" />
      </div>
      <div>
        <div style="font-weight:700">Centro Educacional Popular</div>
        <div style="font-size:14px;color:var(--muted)">Saber Viver ‚Äî Ilha de Deus</div>
      </div>
    </div>
    <h2>Bem-vindo(a) de volta</h2>
    <p class="footnote">Acesse a √°rea administrativa para gerenciar atividades, cadastros e relat√≥rios da ONG.</p>
  </section>

  <aside class="card">
    <h1>Entrar</h1>
    <p class="lead">Fa√ßa login para continuar ‚Äî √© r√°pido e seguro.</p>
    <form id="loginForm">
      <div>
        <label for="login">Login</label>
        <input id="login" type="text" placeholder="Seu login" required autocomplete="username">
      </div>
      <div>
        <label for="password">Senha</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
          <button type="button" class="toggle-pass" onclick="togglePassword()">Mostrar</button>
        </div>
      </div>
      <div class="meta">
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="remember"> <span> Lembrar-me </span></label>
      </div>
      <div style="display:flex;justify-content:center;margin-top:16px">
        <button class="btn" type="submit">Entrar</button>
      </div>
    </form>
    <div style="margin-top:16px;font-size:13px;color:var(--muted)">
      <strong>Sistema de Autentica√ß√£o:</strong><br>
      <div style="margin-top:8px;padding:8px;background:#f8f9fa;border-radius:6px;font-size:12px">
        ‚úÖ Conectado diretamente √† API<br>
        üåê URL: https://saberviver-api.up.railway.app/<br>
        üîë Tokens JWT gerados pela API<br>
        üì± Use suas credenciais fornecidas pelo administrador
      </div>
    </div>
  </aside>
</main>

<script>
// Toggle senha
function togglePassword(){
  const pwd = document.getElementById('password');
  const btn = document.querySelector('.toggle-pass');
  if(pwd.type === 'password'){ pwd.type='text'; btn.textContent='Ocultar'; }
  else{ pwd.type='password'; btn.textContent='Mostrar'; }
}

// Verificar status da API (simplificado)
async function checkAPIStatus() {
  const indicator = document.getElementById('statusIndicator');
  indicator.style.display = 'block';
  indicator.textContent = 'üåê Pronto para login';
  indicator.className = 'status-indicator status-api';
  return true; // Sempre retorna true, teste real ser√° no login
}

// Autentica√ß√£o via API
async function authenticateWithAPI(login, senha) {
  console.log('üåê Autenticando via API...');
  
  try {
    const response = await fetch('https://saberviver-api.up.railway.app/auth/login', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify({ login, senha })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.message || `Erro HTTP: ${response.status}`);
    }
    
    console.log('‚úÖ Autentica√ß√£o via API bem-sucedida');
    console.log('ÔøΩ Dados recebidos:', data);
    
    return data;
  } catch (error) {
    console.error('‚ùå Erro na autentica√ß√£o:', error.message);
    throw error;
  }
}

// Login direto com API
document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const login = document.getElementById('login').value.trim();
  const senha = document.getElementById('password').value;
  
  if(!login || !senha) {
    return alert('Preencha login e senha.');
  }

  const submitButton = e.target.querySelector('.btn');
  const originalText = submitButton.textContent;
  
  try {
    submitButton.textContent = 'Entrando...';
    submitButton.disabled = true;
    
    // Tentar autenticar diretamente via API
    const authData = await authenticateWithAPI(login, senha);
    
    // Verificar se o token foi retornado
    if (!authData.token && !authData.access_token && !authData.jwt) {
      throw new Error('Token n√£o recebido da API');
    }
    
    console.log('üíæ Preparando dados para localStorage...');
    
    // Normalizar token (pode vir como token, access_token ou jwt)
    const finalToken = authData.token || authData.access_token || authData.jwt;
    
    // Normalizar dados do usu√°rio
    let finalUser = authData.user;
    if (!finalUser && authData.usuario) {
      finalUser = authData.usuario;
    }
    if (!finalUser && authData.data) {
      finalUser = authData.data;
    }
    
    console.log('üîç Dados normalizados:');
    console.log('- Token:', finalToken ? 'PRESENTE' : 'AUSENTE');
    console.log('- Usu√°rio:', finalUser ? 'PRESENTE' : 'AUSENTE');
    
    if (!finalToken) {
      throw new Error('Nenhum token v√°lido encontrado na resposta da API');
    }
    
    console.log('üíæ Salvando dados no localStorage...');
    
    // Salvar token e dados do usu√°rio com verifica√ß√£o
    try {
      localStorage.setItem('saberviver_token', finalToken);
      localStorage.setItem('saberviver_token_timestamp', Date.now().toString());
      
      if (finalUser) {
        localStorage.setItem('saberviver_user_data', JSON.stringify(finalUser));
      }
      
      // Verifica√ß√£o imediata
      const savedToken = localStorage.getItem('saberviver_token');
      const savedUser = localStorage.getItem('saberviver_user_data');
      
      if (!savedToken) {
        throw new Error('Falha ao salvar token no localStorage');
      }
      
      console.log('üîç Verificando dados salvos:');
      console.log('‚úÖ Token salvo:', savedToken === finalToken ? 'CORRETO' : 'ERRO');
      console.log('‚úÖ Usu√°rio salvo:', savedUser ? 'SIM' : 'N√ÉO');
      
    } catch (storageError) {
      console.error('‚ùå Erro ao salvar no localStorage:', storageError);
      throw new Error('Falha ao salvar dados de autentica√ß√£o');
    }
    
    console.log('üéâ Login realizado com sucesso!');
    console.log('üë§ Usu√°rio:', finalUser?.nome || finalUser?.name || 'N/A');
    console.log('üé≠ Role:', finalUser?.role || finalUser?.tipo || finalUser?.perfil || 'N/A');
    console.log('üîë Token (in√≠cio):', finalToken.substring(0, 50) + '...');
    
    // Atualizar indicador de status
    const indicator = document.getElementById('statusIndicator');
    indicator.textContent = '‚úÖ Autenticado';
    indicator.className = 'status-indicator status-api';
    
    // Verifica√ß√£o final antes do redirecionamento
    setTimeout(() => {
      console.log('üîÑ Iniciando redirecionamento...');
      
      // Verifica√ß√£o final
      const finalCheck = localStorage.getItem('saberviver_token');
      if (!finalCheck) {
        console.error('‚ùå ERRO CR√çTICO: Token desapareceu antes do redirecionamento!');
        alert('Erro: Token perdido durante o processo. Tente novamente.');
        return;
      }
      
      console.log('üîç Verifica√ß√£o final: Token ainda presente');
      console.log('üöÄ Redirecionando para painel...');
      
      // Usar replace para evitar bot√£o voltar problem√°tico
      window.location.replace('painel.html');
    }, 1500);  // Aumentado para 1.5 segundos
    
  } catch (err) {
    console.error('‚ùå Erro no login:', err.message);
    
    // Atualizar indicador de status em caso de erro
    const indicator = document.getElementById('statusIndicator');
    indicator.textContent = '‚ùå Falha na autentica√ß√£o';
    indicator.className = 'status-indicator status-local';
    
    alert(err.message || 'Erro no login. Verifique suas credenciais e a conex√£o com a API.');
  } finally {
    submitButton.textContent = originalText;
    submitButton.disabled = false;
  }
});

// Verificar status da API ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', () => {
  checkAPIStatus();
});
</script>
</body>
</html>